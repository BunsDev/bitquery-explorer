
<div class="col-lg-12 mb-4">
  <div class="card">
    <div class="card-header">Accumulated data by continent, sorted by confirmed cases</div>
    <div class="card-body">
      <div id="continents"><%= t('loading') %></div>
    </div>
  </div>
</div>


<script>

    widgets.callbacks({
        continent_path: function(item){
            return '/covid/continent/'+item.country.continent;
        }
    });

    // var continent_query = new widgets.query(`
    // query($from: ISO8601DateTime, $till: ISO8601DateTime, $limit: Int!, $offset: Int!) {
    //   offchain {
    //    covid {
    //       facts(date: {since: $from, till: $till}, options: {desc: "confirmed", limit: $limit, offset: $offset}){
    //
    //         country {
    //           continent
    //         }
    //
    //         confirmed
    //         recovered
    //         deaths
    //     }
    //    }
    //   }
    //
    // }`);

    // new widgets.table('#continents', continent_query, 'offchain.covid.facts', {
    //     title: 'Country stats',
    //     dataOptions: [
    //         {
    //             title: 'Continent',
    //             type: 'string',
    //             urlCallbackName: 'continent_path',
    //             path: 'country.continent'
    //         },
    //         {
    //             title: 'Confirmed Cases',
    //             type: 'count',
    //             path: 'confirmed'
    //         },
    //         {
    //             title: 'Recovered',
    //             type: 'count',
    //             path: 'recovered'
    //         },
    //         {
    //             title: 'Deaths',
    //             type: 'count',
    //             path: 'deaths'
    //         }
    //     ]
    // });

    var continent_query = new widgets.query(`
    query($from: ISO8601DateTime, $till: ISO8601DateTime, $limit: Int!, $offset: Int!) {
      offchain {
       covid {
          facts(date: {since: $from, till: $till}, options: {desc: "confirmed", limit: $limit, offset: $offset}){
              date {
                date(format: "%d/%m")
                fulldate: date
                month: date(format: "%m")
              }
            country {
              continent
              name
            }

            confirmed
            recovered
            deaths
        }
       }
      }

    }`);

    new widgets.pivotTable('#continents', continent_query, 'offchain.covid.facts', {
        cols: [{
            title: 'Month',
            path: 'date.month',
            include: [{
                title: 'Date',
                path: 'date.fulldate',
                sort: 'asc'
            }]
        }],
        rows: [{
            title: 'Continent',
            path: 'country.continent',
            include: [{
                title: 'Country',
                path: 'country.name',
                metrics: [
                    {
                        title: 'Confirmed',
                        path: 'confirmed'
                    },
                    {
                        title: 'Recovered',
                        path: 'recovered'
                    },
                    {
                        title: 'Deaths',
                        path: 'deaths'
                    }
                ]
            }]
        }],
        sort: {metric: 'Confirmed', direction: 'desc', axis: 'row'},
        limit: {length: 10, other: true, axis: 'row'},
        title: 'Country stats'
    });

    continent_query.request({from: <%= @from.html_safe %>, till: <%= @till.html_safe %>, limit: 450});

    rr.change(function(start, end, clear){
        continent_query.request({from: start, till: end, limit: 450, offset: 0});
    })

</script>